
{% extends "admin/adminbase.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block scripts %}
<script>
// Track navigation to prevent unnecessary reloads
window.addEventListener('beforeunload', function() {
    window.navigationInProgress = true;
});
// Reset navigation flag when page loads
window.addEventListener('load', function() {
    window.navigationInProgress = false;
});
// Auto-refresh every 60 seconds to keep data current
setInterval(function() {
    // Only auto-refresh if user is not actively interacting and page is visible
    if (!document.hidden && !window.navigationInProgress) {
        console.log('Auto-refreshing data...');
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) {
            indicator.style.display = 'block';
            indicator.textContent = 'Auto-updating...';
        }
        setTimeout(function() {
            window.location.reload(true);
        }, 800);
    }
}, 60000);
// Hide refresh indicator on page load
window.addEventListener('load', function() {
    const indicator = document.getElementById('refresh-indicator');
    if (indicator) {
        setTimeout(function() {
            indicator.style.display = 'none';
        }, 1000);
    }
});
// Search functionality
function searchUsers() {
    const searchTerm = document.getElementById('user-search').value.toLowerCase();
    let totalVisible = 0;
    // Search in all columns
    const columns = ['teachers', 'students', 'admins'];
    columns.forEach(function(columnType) {
        const userItems = document.querySelectorAll(`.${columnType}-column .user-item`);
        let columnVisible = 0;
        userItems.forEach(function(item) {
            let match = false;
            const userName = item.querySelector('.user-name').textContent.toLowerCase();
            if (userName.includes(searchTerm)) {
                match = true;
            }
            // For students, also check student number
            if (columnType === 'students') {
                const studentNumberEl = item.querySelector('.user-studentnumber');
                if (studentNumberEl) {
                    const studentNumber = studentNumberEl.textContent.toLowerCase();
                    if (studentNumber.includes(searchTerm)) {
                        match = true;
                    }
                }
            }
            if (match) {
                item.style.display = 'block';
                columnVisible++;
                totalVisible++;
            } else {
                item.style.display = 'none';
            }
        });
        // Show/hide "no users" message
        const noUsersMsg = document.querySelector(`.${columnType}-column .no-users`);
        const hasUsers = document.querySelectorAll(`.${columnType}-column .user-item`).length > 0;
        if (noUsersMsg && hasUsers) {
            noUsersMsg.style.display = columnVisible === 0 && searchTerm !== '' ? 'block' : 'none';
        }
    });
    // Update search results count
    const resultsCount = document.getElementById('search-results-count');
    if (searchTerm === '') {
        resultsCount.textContent = '';
    } else {
        resultsCount.textContent = `Found ${totalVisible} user(s) matching "${searchTerm}"`;
    }
}
// Clear search function
function clearSearch() {
    document.getElementById('user-search').value = '';
    searchUsers();
}

function confirmDeleteUser(userName, userRole, form) {
    if (confirm('Are you sure you want to delete this ' + userRole + ' account?\n\nUser: ' + userName + '\n\nThis action cannot be undone!')) {
        form.submit();
    }
}
</script>
{% endblock %}

{% block admin_content %}
<h1>Admin Dashboard</h1>

<!-- Search Bar -->
<div class="search-container">
    <input type="text" 
           id="user-search" 
           class="search-bar" 
           placeholder="Search users by name or student number..." 
           oninput="searchUsers()"
           autocomplete="off">
    <span class="search-icon">
        <i class="bi bi-search"></i>
    </span>
</div>

<!-- Search Results Count -->
<div id="search-results-count" class="search-results-count"></div>

<!-- Auto-refresh indicator -->
<div id="refresh-indicator">
    Updating data...
</div>

<div class="row">
    <!-- Teachers Column -->
    <div class="col-lg-4 teacher-column">
        <h2>Teachers <span class="user-count">{{ teachers|length }}</span></h2>
        <ul class="user-list">
            {% for teacher in teachers %}
               <div class="user-item d-flex justify-content-between align-items-center gap-2">
                   <a href="{{ url_for('admin.teacher_profile', user_id=teacher.id) }}" class="flex-fill text-decoration-none text-reset min-width-0">
                       <div class="user-name">
                           {{ teacher.get_full_name() if teacher.get_full_name() else teacher.email }}
                       </div>
                   </a>
                   <form method="post" action="{{ url_for('admin.delete_user', user_id=teacher.id) }}" class="m-0 d-inline">
                       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                       <button type="button" class="btn btn-sm btn-outline-danger user-delete-btn" title="Delete Teacher" onclick="confirmDeleteUser('{{ teacher.get_full_name()|e }}', 'teacher', this.form)">&times;</button>
                   </form>
               </div>
            {% else %}
            <div class="no-users">No teachers found.</div>
            {% endfor %}
        </ul>
    </div>

    <!-- Students Column -->
    <div class="col-lg-4 student-column">
           <h2>Students <span class="user-count">{{ students|length }}</span></h2>
           <ul class="user-list">
               {% for student in students %}
               <div class="user-item d-flex justify-content-between align-items-center gap-2">
                   <a href="{{ url_for('admin.student_profile', user_id=student.id) }}" class="flex-fill text-decoration-none text-reset min-width-0">
                       <div class="d-flex gap-2 align-items-center">
                           <span class="user-studentnumber fs-5 fw-medium text-body">{{ student.studentnumber }}</span>
                           <span class="user-name fs-5 fw-medium text-body">{{ student.get_full_name() if student.get_full_name() else student.email }}</span>
                       </div>
                   </a>
                   <form method="post" action="{{ url_for('admin.delete_user', user_id=student.id) }}" class="m-0 d-inline">
                       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                       <button type="button" class="btn btn-sm btn-outline-danger user-delete-btn" title="Delete Student" onclick="confirmDeleteUser('{{ student.get_full_name()|e }}', 'student', this.form)">&times;</button>
                   </form>
               </div>
               {% else %}
               <div class="no-users">No students found.</div>
               {% endfor %}
           </ul>
    </div>

    <!-- Admins Column -->
    <div class="col-lg-4 admin-column">
        <h2>Admins <span class="user-count">{{ admins|length }}</span></h2>
        <ul class="user-list">
            {% for admin_user in admins %}
               <div class="user-item d-flex justify-content-between align-items-center gap-2">
                   <a href="{{ url_for('admin.teacher_profile', user_id=admin_user.id) }}" class="flex-fill text-decoration-none text-reset min-width-0">
                       <div class="user-name">
                           {{ admin_user.get_full_name() if admin_user.get_full_name() else admin_user.email }}
                       </div>
                   </a>
                   <form method="post" action="{{ url_for('admin.delete_user', user_id=admin_user.id) }}" class="m-0 d-inline">
                       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                       
                       <button type="button" class="btn btn-sm btn-outline-danger user-delete-btn {% if admin_user.id == current_user_id %}invisible{% endif %}" title="Delete Admin" onclick="confirmDeleteUser('{{ admin_user.get_full_name()|e }}', 'admin', this.form)">&times;</button>
                       {% if admin_user.id == current_user_id %}
                            <span class="badge bg-secondary ms-1">You</span>
                       {% endif %}
                   </form>
               </div>
            {% else %}
            <div class="no-users">No admins found.</div>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}
