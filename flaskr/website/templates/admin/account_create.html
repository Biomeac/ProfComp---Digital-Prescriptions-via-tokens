{% extends "admin/adminbase.html" %}

{% block title %}Create Account{% endblock %}

{% block head %}
{{ super() }}
    <style>
    /* Mini role badge styles for account card header */
    .account-role-badge {
        display: inline-block;
        padding: 0.15em 0.7em;
        font-size: 0.92em;
        font-weight: 600;
        border-radius: 0.8em;
        margin-left: 0.6em;
        vertical-align: middle;
        letter-spacing: 0.01em;
        text-transform: capitalize;
    }
    .account-role-admin {
        background: #ffd6e6;
        color: #b8004c;
        border: 1px solid #ffb3d1;
    }
    .account-role-teacher {
        background: #fff7d6;
        color: #b88a00;
        border: 1px solid #ffe9a3;
    }
    .account-role-student {
        background: #d6eaff;
        color: #0056b8;
        border: 1px solid #a3d1ff;
    }
    /* Custom disabled style for student number in dark mode */
    html[data-bs-theme="dark"] #studentnumber:disabled {
        background-color: #181b1f !important;
        color: #666 !important;
        border-color: #333 !important;
    }
    /* Hide browser scrollbars and prevent scrolling */
    html, body {
        overflow: hidden !important;
    }
    /* Main content scroll area below top bar */
    .admin-main-scroll-area {
        overflow-y: scroll; /* Always show vertical scrollbar */
        max-height: calc(100vh - 70px); /* adjust 70px to match your top bar height */
        min-height: 400px;
        padding-bottom: 2rem;
    }
    .container {
        min-height: 0;
    }
    /* Hide scrollbar and arrows for admin-main-scroll-area */
    .admin-main-scroll-area {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE 10+ */
    }
    .admin-main-scroll-area::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    </style>
    <script>
        // Track form submission to prevent duplicate submissions
        let formSubmitted = false;
        
        function preventDuplicateSubmission() {
            if (formSubmitted) {
                alert('Account creation already in progress. Please wait.');
                return false;
            }
            formSubmitted = true;
            
            // Disable the submit button and show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Account...';
                submitBtn.style.opacity = '0.6';
            }
            
            return true;
        }
        
        // Always reset to fresh state when page loads (including back navigation)
        window.addEventListener('load', function() {
            resetToFreshState();
        });
        
        // Reset form when user navigates back using browser cache
        window.addEventListener('pageshow', function(event) {
            // This fires when page is shown, including from back/forward cache
            resetToFreshState();
        });
        
        function resetToFreshState() {
            // Reset form submission state
            formSubmitted = false;
            
            // Reset submit button
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
                submitBtn.style.opacity = '1';
            }
            
            // Clear all form fields for a fresh start
            const form = document.querySelector('form');
            if (form) {
                // Clear all input fields except CSRF token
                const inputs = form.querySelectorAll('input:not([name="csrf_token"]), select');
                inputs.forEach(function(input) {
                    if (input.type === 'text' || input.type === 'email' || input.type === 'password' || input.type === 'number') {
                        input.value = '';
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0; // Reset to first option
                    }
                });
            }
            
            // Reset student number field state
            toggleStudentNumber();
            
            console.log('Account creation form reset to fresh state');
        }
        
        // Function to toggle student number field based on role
        function toggleStudentNumber() {
            const roleSelect = document.getElementById('role');
            const studentNumberField = document.getElementById('studentnumber');
            const studentNumberLabel = document.querySelector('label[for="studentnumber"]');
            
            if (roleSelect && studentNumberField) {
                if (roleSelect.value === 'student') {
                    studentNumberField.disabled = false;
                    studentNumberField.style.backgroundColor = '';
                    studentNumberField.style.color = '';
                    studentNumberField.required = true;
                    if (studentNumberLabel) {
                        studentNumberLabel.style.color = 'var(--bs-body-color)';
                    }
                } else {
                    studentNumberField.disabled = true;
                    studentNumberField.style.backgroundColor = '#f5f5f5';
                    studentNumberField.style.color = '#999';
                    studentNumberField.value = '';
                    studentNumberField.required = false;
                    if (studentNumberLabel) {
                        studentNumberLabel.style.color = '#999';
                    }
                }
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            toggleStudentNumber();
        });
    </script>
{% endblock %}

{% block admin_content %}
<div class="admin-main-scroll-area">
  <div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h1 class="mb-4">Create Accounts</h1>
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{% if category == 'error' %}danger{% else %}{{ category }}{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <button id="add-account-btn" class="btn btn-success mb-4" type="button">
                <span style="font-size: 1.3em; font-weight: bold; margin-right: 6px;">+</span> Add New Account
            </button>
            <div id="account-cards-container"></div>
            <button id="create-accounts-btn" class="btn btn-primary mt-3" style="display:none;" type="button">Create Account(s)</button>
            <div id="batch-create-feedback" class="mt-2"></div>
        </div>
    </div>
  </div>
</div>
</div>
<template id="account-card-template">
    <div class="card mb-4 account-card" style="cursor:pointer;">
        <div class="card-header d-flex align-items-center justify-content-between clickable-card-header" style="cursor:pointer;">
            <span>
                <span class="account-header-name">New Account</span>
                <span class="account-header-role"></span>
            </span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-account-card ms-2" title="Remove Card">&times;</button>
        </div>
        <div class="card-body card-body-collapsible">
            <form method="POST" class="account-create-form needs-validation" novalidate>
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.role.label(class="form-label") }}
                    {{ form.role(class="form-select role-select") }}
                </div>
                <div class="mb-3">
                    {{ form.studentnumber.label(class="form-label") }}
                    {{ form.studentnumber(class="form-control studentnumber-field") }}
                </div>
                <div class="mb-3">
                    {{ form.first_name.label(class="form-label") }}
                    {{ form.first_name(class="form-control") }}
                </div>
                <div class="mb-3">
                    {{ form.last_name.label(class="form-label") }}
                    {{ form.last_name(class="form-control") }}
                </div>
                <div class="mb-3">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control") }}
                </div>
                <div class="mb-3">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-control") }}
                </div>
                <div class="d-flex gap-2 mt-4">
                    <!-- Hide individual submit, only show cancel -->
                    <button type="button" class="btn btn-secondary remove-account-card">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</template>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('add-account-btn');
    const container = document.getElementById('account-cards-container');
    const template = document.getElementById('account-card-template');
    const createBtn = document.getElementById('create-accounts-btn');

    // Show/hide create button based on card count
    function updateCreateBtnVisibility() {
        createBtn.style.display = container.children.length > 0 ? '' : 'none';
    }
    // --- Save/restore state helpers ---
    function getAllCardStates() {
        const cards = Array.from(container.querySelectorAll('.account-card'));
        return cards.map(card => {
            const form = card.querySelector('form');
            const role = form.querySelector('.role-select').value;
            const studentnumber = form.querySelector('.studentnumber-field').value;
            const first_name = form.querySelector('input[name="first_name"]').value;
            const last_name = form.querySelector('input[name="last_name"]').value;
            const email = form.querySelector('input[name="email"]').value;
            const password = form.querySelector('input[name="password"]').value;
            const expanded = card.querySelector('.card-body-collapsible').style.display !== 'none';
            return { role, studentnumber, first_name, last_name, email, password, expanded };
        });
    }
    function saveCardsToStorage() {
        const state = getAllCardStates();
        localStorage.setItem('accountCards', JSON.stringify(state));
    }
    function clearCardsFromStorage() {
        localStorage.removeItem('accountCards');
    }
    function restoreCardsFromStorage() {
        const state = localStorage.getItem('accountCards');
        if (!state) return;
        try {
            const cards = JSON.parse(state);
            if (!Array.isArray(cards)) return;
            cards.forEach(cardData => addAccountCard(cardData));
        } catch (e) { /* ignore */ }
    }

    // --- Card creation logic ---
    function addAccountCard(cardData) {
        const clone = template.content.cloneNode(true);
        // Remove handler (both in header and in form)
        clone.querySelectorAll('.remove-account-card').forEach(btn => {
            btn.onclick = function() {
                this.closest('.account-card').remove();
                saveCardsToStorage();
                updateCreateBtnVisibility();
            };
        });
        // Collapsible logic: expand/collapse on header click (except remove button)
        const card = clone.querySelector('.card');
        const cardHeader = clone.querySelector('.clickable-card-header');
        const cardBody = clone.querySelector('.card-body-collapsible');
        let expanded = true;
        function setExpanded(state) {
            expanded = state;
            if (expanded) {
                cardBody.style.display = '';
                cardHeader.style.borderBottomLeftRadius = '';
                cardHeader.style.borderBottomRightRadius = '';
            } else {
                cardBody.style.display = 'none';
                cardHeader.style.borderBottomLeftRadius = '0.5rem';
                cardHeader.style.borderBottomRightRadius = '0.5rem';
            }
            saveCardsToStorage();
        }
        cardHeader.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-account-card')) return;
            setExpanded(!expanded);
        });
        // Dynamic card header update (name and role)
        const cardHeaderName = clone.querySelector('.account-header-name');
        const cardHeaderRole = clone.querySelector('.account-header-role');
        const firstNameInput = clone.querySelector('input[name="first_name"]');
        const lastNameInput = clone.querySelector('input[name="last_name"]');
        const roleSelect = clone.querySelector('.role-select');
        function updateHeader() {
            const first = firstNameInput.value.trim();
            const last = lastNameInput.value.trim();
            cardHeaderName.textContent = (first || last) ? `${first} ${last}`.trim() : 'New Account';
            const role = roleSelect.value;
            cardHeaderRole.innerHTML = '';
            if (role) {
                let badgeClass = '';
                if (role === 'admin') badgeClass = 'account-role-badge account-role-admin';
                else if (role === 'teacher') badgeClass = 'account-role-badge account-role-teacher';
                else if (role === 'student') badgeClass = 'account-role-badge account-role-student';
                if (badgeClass) {
                    const badge = document.createElement('span');
                    badge.className = badgeClass;
                    badge.textContent = role;
                    cardHeaderRole.appendChild(badge);
                }
            }
            saveCardsToStorage();
        }
        firstNameInput.addEventListener('input', updateHeader);
        lastNameInput.addEventListener('input', updateHeader);
        roleSelect.addEventListener('change', updateHeader);

        // Student number toggle logic
        const studentNumberField = clone.querySelector('.studentnumber-field');
        function toggleStudentNumberField() {
            if (roleSelect.value === 'student') {
                studentNumberField.disabled = false;
                studentNumberField.required = true;
                studentNumberField.style.backgroundColor = '';
                studentNumberField.style.color = '';
            } else {
                studentNumberField.disabled = true;
                studentNumberField.required = false;
                studentNumberField.value = '';
                studentNumberField.style.backgroundColor = '#f5f5f5';
                studentNumberField.style.color = '#999';
            }
            saveCardsToStorage();
        }
        roleSelect.addEventListener('change', toggleStudentNumberField);
        setExpanded(cardData && typeof cardData.expanded === 'boolean' ? cardData.expanded : true);
        container.appendChild(clone);
        // Attach event listeners to all input/select fields in the newly added card (now in DOM)
        const newCard = container.lastElementChild;
        newCard.querySelectorAll('input,select').forEach(input => {
            input.addEventListener('input', saveCardsToStorage);
            input.addEventListener('change', saveCardsToStorage);
        });
        // --- Restore card data if provided (after DOM insert and listeners) ---
        if (cardData) {
            const roleSelectNew = newCard.querySelector('.role-select');
            const studentNumberFieldNew = newCard.querySelector('.studentnumber-field');
            const firstNameInputNew = newCard.querySelector('input[name="first_name"]');
            const lastNameInputNew = newCard.querySelector('input[name="last_name"]');
            const emailInputNew = newCard.querySelector('input[name="email"]');
            const passwordInputNew = newCard.querySelector('input[name="password"]');
            if (roleSelectNew) roleSelectNew.value = cardData.role || '';
            if (studentNumberFieldNew) studentNumberFieldNew.value = cardData.studentnumber || '';
            if (firstNameInputNew) firstNameInputNew.value = cardData.first_name || '';
            if (lastNameInputNew) lastNameInputNew.value = cardData.last_name || '';
            if (emailInputNew) emailInputNew.value = cardData.email || '';
            if (passwordInputNew) passwordInputNew.value = cardData.password || '';
            // After setting values, update UI logic
            if (typeof toggleStudentNumberField === 'function') toggleStudentNumberField.call(roleSelectNew);
            if (typeof updateHeader === 'function') updateHeader.call(firstNameInputNew);
        } else {
            toggleStudentNumberField();
            updateHeader();
        }
        updateCreateBtnVisibility();
    }
    addBtn.onclick = function() { addAccountCard(); saveCardsToStorage(); };

    // Restore cards on load
    restoreCardsFromStorage();
    updateCreateBtnVisibility();


    // Save state on page unload
    window.addEventListener('beforeunload', saveCardsToStorage);

    // Batch create accounts button logic
    createBtn.onclick = function() {
        const cards = Array.from(container.querySelectorAll('.account-card'));
        let validAccounts = [];
        let invalidCards = [];
        cards.forEach(card => {
            const form = card.querySelector('form');
            const role = form.querySelector('.role-select').value.trim();
            const first = form.querySelector('input[name="first_name"]').value.trim();
            const last = form.querySelector('input[name="last_name"]').value.trim();
            const email = form.querySelector('input[name="email"]').value.trim();
            const password = form.querySelector('input[name="password"]').value.trim();
            let valid = role && first && last && email && password;
            let studentnumber = '';
            if (role === 'student') {
                studentnumber = form.querySelector('.studentnumber-field').value.trim();
                valid = valid && studentnumber;
            }
            // For admin/teacher, studentnumber is not required
            if (valid) {
                validAccounts.push({
                    role, first_name: first, last_name: last, email, password, studentnumber
                });
            } else {
                invalidCards.push(card);
            }
        });
        // Highlight invalid cards
        invalidCards.forEach(card => {
            card.classList.add('border-danger');
            setTimeout(() => card.classList.remove('border-danger'), 1500);
        });
        if (validAccounts.length === 0) {
            alert('Please fill all required fields in at least one account card.');
            return;
        }
        // Send AJAX request to batch endpoint
        fetch('/admin/batch_create_accounts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ accounts: validAccounts })
        })
        .then(response => response.json())
        .then(data => {
            const feedback = document.getElementById('batch-create-feedback');
            if (data.success) {
                // Remove cards for successful accounts
                cards.forEach(card => {
                    const form = card.querySelector('form');
                    const email = form.querySelector('input[name="email"]').value.trim();
                    if (data.created_emails.includes(email)) {
                        card.remove();
                    }
                });
                saveCardsToStorage();
                updateCreateBtnVisibility();
                feedback.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            } else {
                feedback.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        })
        .catch(() => {
            document.getElementById('batch-create-feedback').innerHTML = '<div class="alert alert-danger">Error creating accounts. Please try again.</div>';
        });
    };
});
</script>
{% endblock %}
