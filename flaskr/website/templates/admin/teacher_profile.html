{% extends "admin/adminbase.html" %}
{% block title %}Teacher Profile{% endblock%}

{% block styles %}
{{ super() }}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/teacher_profile.css') }}"
/>
{% endblock %}

{% block admin_content %}
  <div class="row justify-content-center card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="card-title mb-0">Teacher Information</h2>
      <div class="d-flex align-items-center gap-2">
        <form
          id="update-user-form"
          method="post"
          action="{{ url_for('admin.update_user', user_id=user.id) }}"
          class="d-inline m-0"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="btn btn-success btn-sm">
            Confirm Changes
          </button>
        </form>
        {% if not is_curr_user %}
        <form
          id="delete-user-form"
          method="post"
          action="{{ url_for('admin.delete_user', user_id=user.id) }}"
          class="d-inline m-0"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <button
            type="button"
            onclick="confirmDelete('{{ user.get_full_name() }}', '{{ user.role }}')"
            class="btn btn-danger btn-sm"
          >
            Delete Account
          </button>
        </form>
        {% else %}
        <div
          class="alert alert-warning d-flex align-items-center small p-1 mb-0"
          role="alert"
        >
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span
            >You are editing your own admin account. Changes here will affect
            your access.</span
          >
        </div>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <form
        id="info-form"
        method="post"
        action="{{ url_for('admin.update_user', user_id=user.id) }}"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="mb-3">
          <label class="form-label">First Name</label>
          <input type="text" class="form-control" name="first_name" value="{{
          user.first_name }}"">
        </div>
        <div class="mb-3">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-control" name="last_name" value="{{
          user.last_name }}"">
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email" value="{{
          user.email }}"">
        </div>
      </form>
      <form
        method="post"
        action="{{ url_for('admin.change_password', user_id=user.id) }}"
      >
        {{ password_form.hidden_tag() }}
        <div class="password-wrapper mb-3">
          {{ password_form.new_password.label(class="form-label") }}
          <div class="password-wrapper position-relative" id="password-wrapper">
            {{ password_form.new_password(class="form-control password-wrapper",
            disabled=True) }}
            <i
              class="bi bi-lock position-absolute top-50 start-50 translate-middle"
            ></i>
          </div>
          {% if password_form.new_password.errors %} {% for error in
          password_form.new_password.errors %}
          <div class="text-danger small">{{ error }}</div>
          {% endfor %} {% endif %}
        </div>
        <button
          type="submit"
          class="btn btn-primary invisible"
          id="change-password-btn"
        >
          Change Password
        </button>
      </form>
      <script>
        // Submit info-form when Confirm Changes is clicked
        document
          .getElementById("update-user-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            document.getElementById("info-form").submit();
          });
      </script>
    </div>

    {% if user.is_teacher() %}
    <div class="card mt-4">
      <div class="card-header">
        <h2 class="card-title mb-0">Assigned Students</h2>
      </div>
      <div class="card-body">
        <ul id="assigned-students-list" class="list-group list-group-flush">
          {% for student in user.students %}
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span
              >{{ student.studentnumber }} {{ student.get_full_name() }}</span
            >
            <form
              class="unassign-student-form d-inline"
              method="post"
              action="{{ url_for('admin.unassign_student') }}"
            >
              {{ form.csrf_token }}
              <input type="hidden" name="teacher_id" value="{{ user.id }}" />
              <input type="hidden" name="student_id" value="{{ student.id }}" />
              <button type="submit" class="btn btn-sm btn-outline-danger">
                Unassign
              </button>
            </form>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No students assigned.</li>
          {% endfor %}
        </ul>

        <div class="mt-3">
          <button id="assign-students-btn" class="btn btn-primary">
            Assign Students
          </button>
        </div>

        <!-- Modal -->
        <div id="assignModal" class="modal" style="display: none">
          <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>Assign Students</h2>
            <!-- Search bar -->
            <input
              type="text"
              id="student-search"
              placeholder="Search students..."
              class="form-control mb-3"
            />
            <ul id="students-list" class="list-group">
              {# Unassigned students first #} {% for student in
              students|selectattr('studentnumber')|sort(attribute='studentnumber')
              if student not in user.students %}
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <span class="student-name">
                  {{ student.studentnumber }} {{ student.get_full_name() }}
                </span>
                <form
                  class="assign-student-form d-inline"
                  method="post"
                  action="{{ url_for('admin.assign_student') }}"
                >
                  {{ form.csrf_token }}
                  <input
                    type="hidden"
                    name="teacher_id"
                    value="{{ user.id }}"
                  />
                  <input
                    type="hidden"
                    name="student_id"
                    value="{{ student.id }}"
                  />
                  <button type="submit" class="btn btn-sm btn-outline-primary">
                    Assign
                  </button>
                </form>
              </li>
              {% endfor %} {# Assigned students at the bottom #} {% for student
              in
              students|selectattr('studentnumber')|sort(attribute='studentnumber')
              if student in user.students %}
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <span class="student-name">
                  {{ student.studentnumber }} {{ student.get_full_name() }}
                </span>
                <form
                  class="assign-student-form d-inline"
                  method="post"
                  action="{{ url_for('admin.assign_student') }}"
                >
                  {{ form.csrf_token }}
                  <input
                    type="hidden"
                    name="teacher_id"
                    value="{{ user.id }}"
                  />
                  <input
                    type="hidden"
                    name="student_id"
                    value="{{ student.id }}"
                  />
                  <button
                    type="submit"
                    class="btn btn-sm btn-outline-primary"
                    disabled
                  >
                    Already Assigned
                  </button>
                </form>
              </li>
              {% endfor %} {% if students|length == 0 %}
              <li class="list-group-item text-muted">No students found.</li>
              {% endif %}
            </ul>
          </div>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            var modal = document.getElementById("assignModal");
            var btn = document.getElementById("assign-students-btn");
            var closeBtn = document.getElementById("closeModal");
            var searchInput = document.getElementById("student-search");
            var studentsList = document.getElementById("students-list");

            if (btn) {
              btn.onclick = function () {
                modal.style.display = "block";
              };
            }

            if (closeBtn) {
              closeBtn.onclick = function () {
                modal.style.display = "none";
              };
            }

            window.onclick = function (event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            };

            if (searchInput && studentsList) {
              searchInput.addEventListener("keyup", function () {
                var filter = searchInput.value.toLowerCase();
                var students = studentsList.getElementsByTagName("li");
                Array.from(students).forEach(function (student) {
                  var text = student.textContent || student.innerText;
                  student.style.display =
                    text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                });
              });
            }
          });
        </script>
      </div>
    </div>
    {% endif %}

    <!-- Delete Account Button moved next to Change Password -->
    <script>
      function confirmDelete(userName, userRole) {
        if (
          confirm(
            "Are you sure you want to delete this account?\n\nUser: " +
              userName +
              "\nRole: " +
              userRole +
              "\n\nThis action cannot be undone!"
          )
        ) {
          document.getElementById("delete-user-form").submit();
        }
      }
    </script>

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
  </div>
{% endblock %}
