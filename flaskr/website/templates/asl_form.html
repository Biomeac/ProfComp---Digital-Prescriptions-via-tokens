<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ASL Data Contract - Patient ASL Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <style>
    body { background: #f6f7fb; }
    .card + .card { margin-top: 1rem; }
    fieldset { border: 0; padding: 0; margin: 0; }
    legend { font-size: 1.1rem; font-weight: 600; margin-bottom: .75rem; }
    .required::after { content: " *"; color: #dc3545; }
    .section-title { font-size: 1.25rem; font-weight: 700; }
    .help-text { font-size: .875rem; color: #6c757d; }
    .remove-item-btn { position: absolute; top: .75rem; right: .75rem; }
    .item-card { position: relative; }
    .muted-badge { background: #eef2ff; color: #334155; }
    .sticky-actions { position: sticky; bottom: 0; background: rgba(246,247,251,.85); backdrop-filter: blur(6px); }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="h3 mb-1">Active Script List (ASL) — Patient Data Form</h1>
      <p class="text-muted mb-0">Complete all required fields. Dates use DD/MM/YYYY format.</p>
      <!-- Debug info -->
      {% if pt_data %}
      <div class="alert alert-info">
        <strong>Debug:</strong> Found existing data for patient - will auto-populate form fields.
        <details>
          <summary>Data preview</summary>
          <pre>{{ pt_data | pprint }}</pre>
        </details>
      </div>
      {% else %}
      <div class="alert alert-warning">
        <strong>Debug:</strong> No existing data found - form will start empty.
      </div>
      {% endif %}
    </header>

    <form class="needs-validation" method="POST" action="{{ url_for('views.asl_form', patient_id=patient.id) }}" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <!-- Patient Info -->
      <div class="card">
        <div class="card-body">
          <h2 class="section-title mb-3">Patient Info</h2>
          <fieldset>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label required" for="medicare">Medicare (11 digits)</label>
                <input type="text" inputmode="numeric" pattern="^\d{11}$" class="form-control" id="medicare" name="pt_data[medicare]" placeholder="49502864011" value="{{ pt_data.medicare if pt_data and pt_data.medicare else (patient.medicare if patient and patient.medicare else '') }}" required />
                <div class="help-text">Must be an 11-digit positive integer.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="entitlement">Pharmaceutical Benefits Entitlement No</label>
                <input type="text" class="form-control" id="entitlement" name="pt_data[pharmaceut-ben-entitlement-no]" placeholder="NA318402K(W)" value="{{ pt_data['pharmaceut-ben-entitlement-no'] if pt_data and pt_data['pharmaceut-ben-entitlement-no'] else (patient.pharmaceut_ben_entitlement_no if patient and patient.pharmaceut_ben_entitlement_no else '') }}" required />
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="preferredContact">Preferred Contact (Phone)</label>
                <input type="tel" class="form-control" id="preferredContact" name="pt_data[preferred-contact]" placeholder="401234567" value="{{ pt_data['preferred-contact'] if pt_data and pt_data['preferred-contact'] else (patient.preferred_contact if patient and patient.preferred_contact else '') }}" required />
                <div class="help-text">Digits/spaces allowed.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="name">Full Name</label>
                <input type="text" class="form-control" id="name" name="pt_data[name]" placeholder="Draga Diaz" value="{{ pt_data.name if pt_data and pt_data.name else (((patient.given_name or '') + ' ' + (patient.last_name or '')).strip() if patient and (patient.given_name or patient.last_name) else '') }}" required />
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="dob">Date of Birth</label>
                <input type="text" class="form-control" id="dob" name="pt_data[dob]" placeholder="26/01/1998" value="{{ pt_data.dob if pt_data and pt_data.dob else (patient.dob if patient and patient.dob else '') }}" required />
                <div class="help-text">DD/MM/YYYY</div>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="scriptDate">Script Date</label>
                <input type="text" class="form-control" id="scriptDate" name="pt_data[script-date]" placeholder="30/11/2020" value="{{ pt_data['script-date'] if pt_data and pt_data['script-date'] else (patient.script_date if patient and patient.script_date else '') }}" required />
                <div class="help-text">DD/MM/YYYY</div>
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="address1">Address Line 1</label>
                <input type="text" class="form-control" id="address1" name="pt_data[address-1]" placeholder="33 JIT DR" value="{{ pt_data['address-1'] if pt_data and pt_data['address-1'] else (patient.address if patient and patient.address else '') }}" required />
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="address2">Address Line 2</label>
                <input type="text" class="form-control" id="address2" name="pt_data[address-2]" placeholder="CHARAM VIC 3318" value="{{ pt_data['address-2'] if pt_data and pt_data['address-2'] else ((patient.suburb + ' ' + patient.state + ' ' + (patient.postcode|string)) if patient and patient.suburb and patient.state and patient.postcode else '') }}" required />
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- Entitlements & Flags -->
      <div class="card">
        <div class="card-body">
          <h2 class="section-title mb-3">Entitlements & Flags</h2>
          <fieldset>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label required" for="sftyNet">Safety Net Cardholder</label>
                <select class="form-select" id="sftyNet" name="pt_data[sfty-net-entitlement-cardholder]" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="rpbsCardholder">RPBS Cardholder</label>
                <select class="form-select" id="rpbsCardholder" name="pt_data[rpbs-ben-entitlement-cardholder]" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="canViewAsl">Can View ASL</label>
                <select class="form-select" id="canViewAsl" name="pt_data[can_view_asl]" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="pbs">PBS</label>
                <input type="text" class="form-control" id="pbs" name="pt_data[pbs]" placeholder="(optional, usually null)" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rpbs">RPBS</label>
                <input type="text" class="form-control" id="rpbs" name="pt_data[rpbs]" placeholder="(optional, usually null)" />
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- Consent Status -->
      <div class="card">
        <div class="card-body">
          <h2 class="section-title mb-3">Consent Status</h2>
          <fieldset>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label required" for="isRegistered">Is Registered</label>
                <select class="form-select" id="isRegistered" name="pt_data[consent-status][is-registered]" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label required" for="consentStatus">Status</label>
                <select class="form-select" id="consentStatus" name="pt_data[consent-status][status]" required>
                  <option value="" selected disabled>Select...</option>
                  <option>No Consent</option>
                  <option>Pending</option>
                  <option>Granted</option>
                  <option>Rejected</option>
                </select>
                <div class="help-text">When not "No Consent", include Last Updated.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="lastUpdated">Last Updated</label>
                <input type="text" class="form-control" id="lastUpdated" name="pt_data[consent-status][last-updated]" placeholder="25/09/2025 06:03 PM" />
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- ASL Prescriptions -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="section-title mb-0">ASL Prescriptions</h2>
            <span class="badge rounded-pill muted-badge">Array: asl-data</span>
          </div>
          <p class="text-muted mb-3">Add one or more ASL prescription items.</p>

          <div id="asl-items" class="d-grid gap-3"></div>

          <div class="mt-2">
            <button type="button" class="btn btn-outline-primary" id="add-asl-item">
              + Add ASL Prescription
            </button>
          </div>
        </div>
      </div>

      <!-- ALR Prescriptions -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="section-title mb-0">ALR Prescriptions</h2>
            <span class="badge rounded-pill muted-badge">Array: alr-data</span>
          </div>
          <p class="text-muted mb-3">Add one or more ALR prescription items.</p>

          <div id="alr-items" class="d-grid gap-3"></div>

          <div class="mt-2">
            <button type="button" class="btn btn-outline-primary" id="add-alr-item">
              + Add ALR Prescription
            </button>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="card sticky-actions mt-3">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="text-muted">Review entries before submitting.</div>
          <button type="submit" class="btn btn-success btn-lg">Submit</button>
        </div>
      </div>
    </form>
  </div>

  <!-- TEMPLATES -->
  <template id="asl-item-template">
    <div class="card item-card">
      <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-action="remove">Remove</button>
      <div class="card-body">
        <legend>ASL Prescription Item</legend>
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label required">Prescription ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][prescription_id]" placeholder="1" required />
          </div>
          <div class="col-md-4">
            <label class="form-label required">DSPID</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][DSPID]" placeholder="MPK00009002011563" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Status</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][status]" placeholder="Available" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Prescribed Date</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescribed-date]" placeholder="10/06/2021" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>

          <div class="col-md-6">
            <label class="form-label required">Drug Name</label>
            <textarea class="form-control" rows="2" name="pt_data[asl-data][__INDEX__][drug-name]" placeholder="Coversyl 5mg tablet, 30 5 mg 30 Tablets" required></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Drug Code</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][drug-code]" placeholder="9007C" required />
            <div class="help-text">4–5 alphanumeric chars.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Instructions</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][dose-instr]" placeholder="ONCE A DAY" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Dose Qty</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][dose-qty]" placeholder="30" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Repeats</label>
            <input type="number" min="0" class="form-control" name="pt_data[asl-data][__INDEX__][dose-rpt]" placeholder="6" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Paperless</label>
            <select class="form-select" name="pt_data[asl-data][__INDEX__][paperless]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Brand Substitution Not Permitted</label>
            <select class="form-select" name="pt_data[asl-data][__INDEX__][brand-sub-not-prmt]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
        </div>

        <hr class="my-3" />

        <legend>Prescriber</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label required">First Name</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][fname]" placeholder="Phillip" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Last Name</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][lname]" placeholder="Davis" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Title / Qualifications</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][title]" placeholder="( MBBS; FRACGP )" />
          </div>

          <div class="col-md-6">
            <label class="form-label required">Address Line 1</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][address-1]" placeholder="Level 3 60 Albert Rd" required />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Address Line 2</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][address-2]" placeholder="SOUTH MELBOURNE VIC 3205" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Prescriber ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][id]" placeholder="987774" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-I (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][hpii]" placeholder="8003619900026805" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-O (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][hpio]" placeholder="8003626566692846" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Phone</label>
            <input type="tel" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][phone]" placeholder="03 9284 3300" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fax (optional)</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][fax]" placeholder="(optional)" />
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="alr-item-template">
    <div class="card item-card">
      <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-action="remove">Remove</button>
      <div class="card-body">
        <legend>ALR Prescription Item</legend>
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label required">Prescription ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][prescription_id]" placeholder="2" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">DSPID (optional)</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][DSPID]" placeholder="(optional, usually null)" />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Drug Name</label>
            <textarea class="form-control" rows="2" name="pt_data[alr-data][__INDEX__][drug-name]" placeholder="Levlen ED Tablets, 150mcg-30mcg(28)" required></textarea>
          </div>

          <div class="col-md-3">
            <label class="form-label required">Drug Code</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][drug-code]" placeholder="1394J" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Instructions</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][dose-instr]" placeholder="ONCE DAILY" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Qty</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][dose-qty]" placeholder="4" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Original Repeats</label>
            <input type="number" min="0" class="form-control" name="pt_data[alr-data][__INDEX__][dose-rpt]" placeholder="6" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Remaining Repeats</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][remaining-repeats]" placeholder="3" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Prescribed Date</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescribed-date]" placeholder="05/07/2021" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dispensed Date</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][dispensed-date]" placeholder="05/07/2021" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Paperless</label>
            <select class="form-select" name="pt_data[alr-data][__INDEX__][paperless]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label required">Brand Substitution Not Permitted</label>
            <select class="form-select" name="pt_data[alr-data][__INDEX__][brand-sub-not-prmt]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
        </div>

        <hr class="my-3" />

        <legend>Prescriber</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label required">First Name</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][fname]" placeholder="Phillip" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Last Name</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][lname]" placeholder="Davis" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Title / Qualifications</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][title]" placeholder="( MBBS; FRACGP )" />
          </div>

          <div class="col-md-6">
            <label class="form-label required">Address Line 1</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][address-1]" placeholder="Level 3 60 Albert Rd" required />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Address Line 2</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][address-2]" placeholder="SOUTH MELBOURNE VIC 3205" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Prescriber ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][id]" placeholder="987774" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-I (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][hpii]" placeholder="8003619900026805" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-O (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][hpio]" placeholder="8003626566692846" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Phone</label>
            <input type="tel" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][phone]" placeholder="03 9284 3300" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fax (optional)</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][fax]" placeholder="(optional)" />
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- JS: minimal cloning for repeatable arrays -->
  <script>
    (function () {
      const aslContainer = document.getElementById('asl-items');
      const alrContainer = document.getElementById('alr-items');
      const aslTemplate = document.getElementById('asl-item-template');
      const alrTemplate = document.getElementById('alr-item-template');
      const addAslBtn = document.getElementById('add-asl-item');
      const addAlrBtn = document.getElementById('add-alr-item');

      function addItem(container, templateEl) {
        const index = container.children.length;
        const clone = templateEl.content.cloneNode(true);
        // Replace placeholder indices in name attributes
        clone.querySelectorAll('[name]').forEach((el) => {
          el.name = el.name.replaceAll('__INDEX__', index.toString());
        });
        container.appendChild(clone);
      }

      function handleRemove(e) {
        const btn = e.target.closest('[data-action="remove"]');
        if (!btn) return;
        const card = btn.closest('.item-card');
        if (card && card.parentElement) {
          const container = card.parentElement;
          card.remove();
          // Reindex remaining items to keep names sequential
          Array.from(container.children).forEach((child, idx) => {
            child.querySelectorAll('[name]').forEach((el) => {
              el.name = el.name.replace(/\[(asl-data|alr-data)\]\[\d+\]/, '[$1][' + idx + ']');
            });
          });
        }
      }

      addAslBtn.addEventListener('click', () => addItem(aslContainer, aslTemplate));
      addAlrBtn.addEventListener('click', () => addItem(alrContainer, alrTemplate));
      document.addEventListener('click', handleRemove);

      // Pre-populate with existing data if available
      const ptData = {{ pt_data|tojson if pt_data else '{}' }};
      console.log('Pre-population data:', ptData);
      console.log('ASL data:', ptData['asl-data']);
      console.log('ALR data:', ptData['alr-data']);
      
      // Populate ASL prescriptions
      if (ptData && ptData['asl-data'] && ptData['asl-data'].length > 0) {
        console.log('Found', ptData['asl-data'].length, 'ASL prescriptions to populate');
        ptData['asl-data'].forEach((aslItem, index) => {
          console.log('Processing ASL item:', index, aslItem);
          const newItem = addItem(aslContainer, aslTemplate);
          if (newItem) {
            // Wait a moment for DOM to update then populate
            setTimeout(() => {
              // Get all input fields in this item
              const inputs = newItem.querySelectorAll('input, select, textarea');
              console.log('Found', inputs.length, 'fields in new ASL item');
              
              // Try to populate each field by matching the name pattern
              inputs.forEach(field => {
                const fieldName = field.getAttribute('name') || '';
                console.log('Checking field:', fieldName);
                
                // Simple field mapping
                if (fieldName.includes('prescription_id') && aslItem.prescription_id) {
                  field.value = aslItem.prescription_id;
                  console.log('Set prescription_id to:', aslItem.prescription_id);
                }
                if (fieldName.includes('DSPID') && aslItem.DSPID) {
                  field.value = aslItem.DSPID;
                  console.log('Set DSPID to:', aslItem.DSPID);
                }
                if (fieldName.includes('drug-name') && aslItem['drug-name']) {
                  field.value = aslItem['drug-name'];
                  console.log('Set drug-name to:', aslItem['drug-name']);
                }
                if (fieldName.includes('drug-code') && aslItem['drug-code']) {
                  field.value = aslItem['drug-code'];
                  console.log('Set drug-code to:', aslItem['drug-code']);
                }
                if (fieldName.includes('dose-qty') && aslItem['dose-qty']) {
                  field.value = aslItem['dose-qty'];
                  console.log('Set dose-qty to:', aslItem['dose-qty']);
                }
                if (fieldName.includes('dose-rpt') && aslItem['dose-rpt']) {
                  field.value = aslItem['dose-rpt'];
                  console.log('Set dose-rpt to:', aslItem['dose-rpt']);
                }
                if (fieldName.includes('prescribed-date') && aslItem['prescribed-date']) {
                  field.value = aslItem['prescribed-date'];
                  console.log('Set prescribed-date to:', aslItem['prescribed-date']);
                }
                if (fieldName.includes('dose-instr') && aslItem['dose-instr']) {
                  field.value = aslItem['dose-instr'];
                  console.log('Set dose-instr to:', aslItem['dose-instr']);
                }
                if (fieldName.includes('status') && aslItem.status) {
                  field.value = aslItem.status;
                  console.log('Set status to:', aslItem.status);
                }
                // Prescriber fields
                if (aslItem.prescriber) {
                  if (fieldName.includes('prescriber][fname') && aslItem.prescriber.fname) {
                    field.value = aslItem.prescriber.fname;
                    console.log('Set prescriber fname to:', aslItem.prescriber.fname);
                  }
                  if (fieldName.includes('prescriber][lname') && aslItem.prescriber.lname) {
                    field.value = aslItem.prescriber.lname;
                    console.log('Set prescriber lname to:', aslItem.prescriber.lname);
                  }
                }
              });
            }, 100);
          }
        });
      } else {
        console.log('No ASL data found, adding empty item');
        // Seed with one empty ASL item if no existing data
        addItem(aslContainer, aslTemplate);
      }
      
      // Populate ALR prescriptions
      if (ptData && ptData['alr-data'] && ptData['alr-data'].length > 0) {
        ptData['alr-data'].forEach((alrItem, index) => {
          const newItem = addItem(alrContainer, alrTemplate);
          if (newItem) {
            // Wait a moment for DOM to update
            setTimeout(() => {
              // Populate ALR fields using exact name patterns
              const populateField = (namePattern, value) => {
                const field = newItem.querySelector(`[name*="${namePattern}"]`);
                if (field && value !== undefined && value !== null && value !== '') {
                  if (field.type === 'checkbox') {
                    field.checked = value === true || value === 'true';
                  } else if (field.tagName === 'SELECT') {
                    field.value = value.toString();
                  } else {
                    field.value = value;
                  }
                  console.log(`Populated ALR ${namePattern} with:`, value);
                }
              };
              
              populateField('prescription_id', alrItem.prescription_id);
              populateField('DSPID', alrItem.DSPID);
              populateField('drug-name', alrItem['drug-name']);
              populateField('drug-code', alrItem['drug-code']);
              populateField('dose-instr', alrItem['dose-instr']);
              populateField('dose-qty', alrItem['dose-qty']);
              populateField('dose-rpt', alrItem['dose-rpt']);
              populateField('prescribed-date', alrItem['prescribed-date']);
              populateField('dispensed-date', alrItem['dispensed-date']);
              populateField('remaining-repeats', alrItem['remaining-repeats']);
              populateField('paperless', alrItem.paperless ? 'true' : 'false');
            }, 10);
          }
        });
      } else {
        // Seed with one empty ALR item if no existing data
        addItem(alrContainer, alrTemplate);
      }

      
    })();
  </script>

  <!-- Bootstrap JS (optional for some components) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script>
  (function () {
    const form = document.querySelector("form.needs-validation");
    console.log("form element:", form); 
  
    // 把带 [] 的 name 转成嵌套 JSON
    function assignNested(obj, path, value) {
      let cur = obj;
      for (let i = 0; i < path.length - 1; i++) {
        const k = path[i];
        if (!(k in cur)) cur[k] = /^\d+$/.test(path[i + 1]) ? [] : {};
        cur = cur[k];
      }
      const last = path[path.length - 1];
      if (Array.isArray(cur)) {
        cur[parseInt(last, 10)] = value;
      } else {
        cur[last] = value;
      }
    }
  
    function formDataToNestedJSON(form) {
      const fd = new FormData(form);
      const out = {};
      for (const [name, value] of fd.entries()) {
        const parts = name.replace(/\]/g, "").split("["); 
        assignNested(out, parts, value);
      }
      return out.pt_data || out;
    }
  
    form.addEventListener("submit", function (e) {
      console.log("submit handler triggered"); 
      
      // Bootstrap validation
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        form.classList.add("was-validated");
        return;
      }
      
      // Allow normal form submission to Flask route
      console.log("Form is valid, submitting to Flask route");
    });
  })();
</script>

  
</body>
</html>


