{% extends "base.html" %}
{% block title %}ASL Data Contract - Patient ASL Form{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js" integrity="sha512-ohlWmsCxOu0bph1om5eDL0jm/83eH09fvqLDhiEdiqfDeJbEvz4FSbeY0gLJSVJwQAp0laRhTXbUQG+ZUuifUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/asl_form.css') }}">
{% endblock %}
{% block body %}
  <div class="container py-4">
    <header class="mb-4 d-flex align-items-center">
    <div>
      <h1 class="h3 mb-1">Active Script List (ASL) — Patient Data Form</h1>
      <p class="text-muted mb-0">Complete all required fields. Fields marked with <span class="text-danger">*</span> are required.</p>
    </div>
    </header>

    <!-- ===== FORM ===== -->
    <form method="POST" class="needs-validation" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

      <!-- ASL Items -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 mb-0">ASL Prescription Items</h2>
          <button type="button" id="add-asl-item" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle"></i> Add ASL Item
          </button>
        </div>
        <div id="asl-items"></div>
      </div>

      <!-- ALR Items -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 mb-0">ALR (Available Local Repeats) Items</h2>
          <button type="button" id="add-alr-item" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle"></i> Add ALR Item
          </button>
        </div>
        <div id="alr-items"></div>
      </div>

      <!-- Submit -->
      <div class="card sticky-actions mt-3">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="text-muted">Review entries before submitting.</div>
          <button type="submit" class="btn btn-success btn-lg">Submit</button>
        </div>
      </div>
    </form>
  </div>

  <!-- TEMPLATES -->
  <template id="asl-item-template">
    <div class="card item-card">
      <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-action="remove">Remove</button>
      <div class="card-body">
        <legend>ASL Prescription Item</legend>
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label required">Prescription ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][prescription_id]" placeholder="1" required />
          </div>
          <div class="col-md-4">
            <label class="form-label required">DSPID</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][DSPID]" placeholder="MPK00009002011563" maxlength="50" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Status</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][status]" placeholder="Available" maxlength="50" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Prescribed Date</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescribed-date]" placeholder="10/06/2021" maxlength="10" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>

          <div class="col-md-6">
            <label class="form-label required">Drug Name</label>
            <textarea class="form-control" rows="2" name="pt_data[asl-data][__INDEX__][drug-name]" placeholder="Coversyl 5mg tablet, 30 5 mg 30 Tablets" maxlength="200" required></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Drug Code</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][drug-code]" placeholder="9007C" maxlength="10" required />
            <div class="help-text">4–6 alphanumeric chars.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Instructions</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][dose-instr]" placeholder="ONCE A DAY" maxlength="200" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Dose Qty</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][dose-qty]" placeholder="30" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Repeats</label>
            <input type="number" min="0" class="form-control" name="pt_data[asl-data][__INDEX__][dose-rpt]" placeholder="6" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Paperless</label>
            <select class="form-select" name="pt_data[asl-data][__INDEX__][paperless]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Brand Substitution Not Permitted</label>
            <select class="form-select" name="pt_data[asl-data][__INDEX__][brand-sub-not-prmt]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
        </div>

        <hr class="my-3" />

        <legend>Prescriber</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label required">First Name</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][fname]" placeholder="Phillip" maxlength="50" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Last Name</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][lname]" placeholder="Davis" maxlength="50" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Title / Qualifications</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][title]" placeholder="( MBBS; FRACGP )" maxlength="100" />
          </div>

          <div class="col-md-6">
            <label class="form-label required">Address Line 1</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][address-1]" placeholder="Level 3 60 Albert Rd" maxlength="100" required />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Address Line 2</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][address-2]" placeholder="SOUTH MELBOURNE VIC 3205" maxlength="100" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Prescriber ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][id]" placeholder="987774" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-I (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][hpii]" placeholder="8003619900026805" maxlength="16" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-O (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][hpio]" placeholder="8003626566692846" maxlength="16" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Phone</label>
            <input type="tel" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][phone]" placeholder="03 9284 3300" maxlength="20" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fax (optional)</label>
            <input type="text" class="form-control" name="pt_data[asl-data][__INDEX__][prescriber][fax]" placeholder="(optional)" maxlength="20" />
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="alr-item-template">
    <div class="card item-card">
      <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-action="remove">Remove</button>
      <div class="card-body">
        <legend>ALR Prescription Item</legend>
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label required">Prescription ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][prescription_id]" placeholder="2" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">DSPID (optional)</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][DSPID]" placeholder="(optional, usually null)" maxlength="50" />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Drug Name</label>
            <textarea class="form-control" rows="2" name="pt_data[alr-data][__INDEX__][drug-name]" placeholder="Levlen ED Tablets, 150mcg-30mcg(28)" maxlength="200" required></textarea>
          </div>

          <div class="col-md-3">
            <label class="form-label required">Drug Code</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][drug-code]" placeholder="1394J" maxlength="10" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Instructions</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][dose-instr]" placeholder="ONCE DAILY" maxlength="200" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dose Qty</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][dose-qty]" placeholder="4" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Original Repeats</label>
            <input type="number" min="0" class="form-control" name="pt_data[alr-data][__INDEX__][dose-rpt]" placeholder="6" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Remaining Repeats</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][remaining-repeats]" placeholder="3" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Prescribed Date</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescribed-date]" placeholder="05/07/2021" maxlength="10" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Dispensed Date</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][dispensed-date]" placeholder="05/07/2021" maxlength="10" required />
            <div class="help-text">DD/MM/YYYY</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required">Paperless</label>
            <select class="form-select" name="pt_data[alr-data][__INDEX__][paperless]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label required">Brand Substitution Not Permitted</label>
            <select class="form-select" name="pt_data[alr-data][__INDEX__][brand-sub-not-prmt]" required>
              <option value="" selected disabled>Select...</option>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
        </div>

        <hr class="my-3" />

        <legend>Prescriber</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label required">First Name</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][fname]" placeholder="Phillip" maxlength="50" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Last Name</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][lname]" placeholder="Davis" maxlength="50" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Title / Qualifications</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][title]" placeholder="( MBBS; FRACGP )" maxlength="100" />
          </div>

          <div class="col-md-6">
            <label class="form-label required">Address Line 1</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][address-1]" placeholder="Level 3 60 Albert Rd" maxlength="100" required />
          </div>
          <div class="col-md-6">
            <label class="form-label required">Address Line 2</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][address-2]" placeholder="SOUTH MELBOURNE VIC 3205" maxlength="100" required />
          </div>

          <div class="col-md-3">
            <label class="form-label required">Prescriber ID</label>
            <input type="number" min="1" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][id]" placeholder="987774" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-I (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][hpii]" placeholder="8003619900026805" maxlength="16" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">HPI-O (16 digits)</label>
            <input type="text" inputmode="numeric" pattern="^\d{16}$" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][hpio]" placeholder="8003626566692846" maxlength="16" required />
          </div>
          <div class="col-md-3">
            <label class="form-label required">Phone</label>
            <input type="tel" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][phone]" placeholder="03 9284 3300" maxlength="20" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fax (optional)</label>
            <input type="text" class="form-control" name="pt_data[alr-data][__INDEX__][prescriber][fax]" placeholder="(optional)" maxlength="20" />
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- JS: minimal cloning for repeatable arrays -->
  <script>
    (function () {
      const aslContainer = document.getElementById('asl-items');
      const alrContainer = document.getElementById('alr-items');
      const aslTemplate = document.getElementById('asl-item-template');
      const alrTemplate = document.getElementById('alr-item-template');
      const addAslBtn = document.getElementById('add-asl-item');
      const addAlrBtn = document.getElementById('add-alr-item');

      function addItem(container, templateEl, data = null, index = null) {
        const itemIndex = index !== null ? index : container.children.length;
        const clone = templateEl.content.cloneNode(true);
        
        // Replace placeholder indices in name attributes
        clone.querySelectorAll('[name]').forEach((el) => {
          el.name = el.name.replaceAll('__INDEX__', itemIndex.toString());
        });
        
        container.appendChild(clone);
        
        // If data is provided, populate the fields immediately after adding to DOM
        if (data) {
          setTimeout(() => {
            // Get the last added item (the one we just added)
            const addedItem = container.lastElementChild;
            
            // Populate prescription fields
            Object.entries(data).forEach(([key, value]) => {
              if (value !== null && value !== undefined && value !== '') {
                // Find field by exact name match in the added item
                const fieldName = `pt_data[${container.id === 'asl-items' ? 'asl' : 'alr'}-data][${itemIndex}][${key}]`;
                const field = addedItem.querySelector(`[name="${fieldName}"]`);
                if (field) {
                  if (field.tagName === 'SELECT') {
                    field.value = value.toString();
                  } else if (field.tagName === 'TEXTAREA') {
                    field.textContent = value;
                  } else {
                    field.value = value;
                  }
                  // Trigger validation check after setting value
                  field.dispatchEvent(new Event('input', { bubbles: true }));
                  console.log(`Pre-populated ${key}:`, value);
                } else {
                  console.log(`Field not found: ${fieldName}`);
                }
              }
            });
            
            // Populate prescriber fields
            if (data.prescriber) {
              Object.entries(data.prescriber).forEach(([key, value]) => {
                if (value !== null && value !== undefined && value !== '') {
                  const fieldName = `pt_data[${container.id === 'asl-items' ? 'asl' : 'alr'}-data][${itemIndex}][prescriber][${key}]`;
                  const field = addedItem.querySelector(`[name="${fieldName}"]`);
                  if (field) {
                    field.value = value;
                    // Trigger validation check after setting value
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    console.log(`Pre-populated prescriber ${key}:`, value);
                  } else {
                    console.log(`Prescriber field not found: ${fieldName}`);
                  }
                }
              });
            }
          }, 10);
        }
        
        return clone;
      }

      function handleRemove(e) {
        const btn = e.target.closest('[data-action="remove"]');
        if (!btn) return;
        const card = btn.closest('.item-card');
        if (card && card.parentElement) {
          const container = card.parentElement;
          card.remove();
          // Reindex remaining items to keep names sequential
          Array.from(container.children).forEach((child, idx) => {
            child.querySelectorAll('[name]').forEach((el) => {
              el.name = el.name.replace(/\[(asl-data|alr-data)\]\[\d+\]/, '[$1][' + idx + ']');
            });
          });
        }
      }

      addAslBtn.addEventListener('click', () => addItem(aslContainer, aslTemplate));
      addAlrBtn.addEventListener('click', () => addItem(alrContainer, alrTemplate));
      document.addEventListener('click', handleRemove);

      // Pre-populate with existing data if available
      const ptData = {{ pt_data|tojson if pt_data else '{}' }};
      console.log('Pre-population data:', ptData);
      
      // Populate ASL prescriptions
      if (ptData && ptData['asl-data'] && ptData['asl-data'].length > 0) {
        console.log('Found existing ASL data, populating', ptData['asl-data'].length, 'items');
        ptData['asl-data'].forEach((aslItem, index) => {
          addItem(aslContainer, aslTemplate, aslItem, index);
        });
      } else {
        console.log('No existing ASL data found, adding empty form');
        addItem(aslContainer, aslTemplate);
      }
      
      // Populate ALR prescriptions
      if (ptData && ptData['alr-data'] && ptData['alr-data'].length > 0) {
        console.log('Found existing ALR data, populating', ptData['alr-data'].length, 'items');
        ptData['alr-data'].forEach((alrItem, index) => {
          addItem(alrContainer, alrTemplate, alrItem, index);
        });
      } else {
        console.log('No existing ALR data found, adding empty form');
        addItem(alrContainer, alrTemplate);
      }
    })();
  </script>
{% endblock %}