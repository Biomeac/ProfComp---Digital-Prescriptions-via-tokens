{% extends "base.html" %}
{% block body %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                {% if current_user.is_teacher() %}
                    <a href="{{ url_for('views.teacher_dashboard') }}">Teacher Dashboard</a>
                {% else %}
                    <a href="{{ url_for('views.student_dashboard') }}">Student Dashboard</a>
                {% endif %}
            </li>
            <li class="breadcrumb-item active">{{ scenario.name }}</li>
        </ol>
    </nav>

    <!-- Scenario Title -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <h2>{{ scenario.name }}</h2>
        {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
        <button class="btn btn-sm btn-outline-secondary" onclick="toggleDescriptionEdit()">
            <i class="bi bi-pencil"></i> Edit Description
        </button>
        {% endif %}
    </div>
    
    <!-- Description Display Mode -->
    <div id="description-display">
        {% if scenario.description %}
            <p class="scenario-description">{{ scenario.description }}</p>
        {% else %}
            <p class="text-muted">No description has been set for this scenario yet.</p>
        {% endif %}
    </div>

    <!-- Description Edit Mode (initially hidden) -->
    {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
    <div id="description-edit" style="display: none;" class="mb-3">
        <form method="POST" action="{{ url_for('views.update_scenario_description', scenario_id=scenario.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="mb-3">
                <label for="description" class="form-label">Scenario Description:</label>
                <textarea class="form-control" id="description" name="description" rows="3" 
                          placeholder="Enter a description for this scenario...">{{ scenario.description or '' }}</textarea>
                <div class="form-text">Provide context and background information for students about this scenario.</div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Description</button>
                <button type="button" class="btn btn-secondary" onclick="cancelDescriptionEdit()">Cancel</button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Teaching Rules Banner -->
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle"></i>
        Each patient has exactly <strong>one Active Script List (ASL)</strong>.  
        Students can only dispense medicines; they cannot edit the ASL.  
        Repeats auto-decrement in real time.
    </div>

    <!-- Instructions / Questions -->
    <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Instructions / Questions</span>
            {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
            <button class="btn btn-sm btn-outline-primary" onclick="toggleQuestionEdit()">
                <i class="bi bi-pencil"></i> Edit
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            <!-- Question Display Mode -->
            <div id="question-display">
                {% if scenario.question_text %}
                    <div class="question-text">{{ scenario.question_text|nl2br|safe }}</div>
                {% else %}
                    <p class="text-muted">No questions have been set for this scenario yet.</p>
                {% endif %}
            </div>

            <!-- Question Edit Mode (initially hidden) -->
            {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
            <div id="question-edit" style="display: none;">
                <form method="POST" action="{{ url_for('views.update_scenario_question', scenario_id=scenario.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="question_text" class="form-label">Scenario Questions/Instructions:</label>
                        <textarea class="form-control" id="question_text" name="question_text" rows="6" 
                                  placeholder="Enter questions or instructions for students...">{{ scenario.question_text or '' }}</textarea>
                        <div class="form-text">You can write multiple questions or instructions. Students will see this when they access the scenario.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Questions</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelQuestionEdit()">Cancel</button>
                    </div>
                </form>
            </div>
            {% endif %}


        </div>
    </div>

    <!-- Assigned Students Section -->
    {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
    <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Assigned Students ({{ assigned_students|length }})</span>
            <a href="{{ url_for('views.assign_dashboard') }}?scenario_id={{ scenario.id }}" class="btn btn-sm btn-warning">
                <i class="bi bi-person-plus"></i> Assign More Students
            </a>
        </div>
        <div class="card-body">
            {% if assigned_students %}
                <div class="row">
                    {% for student in assigned_students %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                        <br><small class="text-muted">Student ID: {{ student.id }}</small>
                                    </div>
                                    <form method="POST" action="{{ url_for('views.unassign_student_from_scenario', scenario_id=scenario.id, student_id=student.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                onclick="return confirm('Remove {{ student.first_name }} {{ student.last_name }} from this scenario? They will no longer be able to access it.')">
                                            <i class="bi bi-x-circle"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if assigned_students|length > 1 %}
                <div class="mt-3">
                    <form method="POST" action="{{ url_for('views.unassign_all_students', scenario_id=scenario.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                onclick="return confirm('Remove ALL students from this scenario? This cannot be undone.')">
                            <i class="bi bi-x-circle"></i> Remove All Students
                        </button>
                    </form>
                </div>
                {% endif %}
            {% else %}
                <p class="text-muted">No students are currently assigned to this scenario.</p>
                <a href="{{ url_for('views.assign_dashboard') }}?scenario_id={{ scenario.id }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-person-plus"></i> Assign Students
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Active Patient -->
    <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Active Patient for this Scenario</span>
            {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
            <button class="btn btn-sm btn-outline-primary" onclick="togglePatientSelection()">
                <i class="bi bi-person-plus"></i> {% if scenario.active_patient %}Change Patient{% else %}Select Patient{% endif %}
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            <!-- Active Patient Display -->
            <div id="patient-display">
                {% if scenario.active_patient %}
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>
                                    {% set title = scenario.active_patient.title or '' %}
                                    {% set given_name = scenario.active_patient.given_name or '' %}
                                    {% set last_name = scenario.active_patient.last_name or '' %}
                                    {% if title or given_name or last_name %}
                                        {{ (title.upper() + ' ' if title else '') + (given_name + ' ' if given_name else '') + (last_name if last_name else '') }}
                                    {% else %}
                                        Unnamed Patient
                                    {% endif %}
                                </strong>
                                <br><small>DOB: {{ scenario.active_patient.dob or 'Not provided' }}</small>
                                <br><small>Medicare: {{ scenario.active_patient.medicare or 'Not provided' }}</small>
                            </div>
                            <div>
                                <a href="{{ url_for('views.patient_asl_form', patient_id=scenario.active_patient.id) }}" class="btn btn-sm btn-success">
                                    <i class="bi bi-list-ul"></i> View ASL
                                </a>
                                <a href="{{ url_for('views.edit_pt', patient_id=scenario.active_patient.id) }}" class="btn btn-sm btn-secondary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
                                <form method="POST" action="{{ url_for('views.remove_active_patient', scenario_id=scenario.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Remove this patient from the scenario?')">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">No patient currently assigned to this scenario.</p>
                {% endif %}
            </div>

            <!-- Patient Selection Mode (initially hidden) -->
            {% if current_user.is_teacher() and scenario.teacher_id == current_user.id %}
            <div id="patient-selection" style="display: none;">
                <form method="POST" action="{{ url_for('views.set_active_patient', scenario_id=scenario.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="patient_id" class="form-label">Select Active Patient:</label>
                        <select class="form-select" id="patient_id" name="patient_id" required>
                            <option value="">Choose a patient...</option>
                            {% for patient in all_patients %}
                            <option value="{{ patient.id }}" {% if scenario.active_patient and patient.id == scenario.active_patient.id %}selected{% endif %}>
                                {{ (patient.title.upper() + ' ' if patient.title else '') + (patient.given_name + ' ' if patient.given_name else '') + (patient.last_name if patient.last_name else 'Unnamed Patient') }}
                                {% if patient.dob %} - DOB: {{ patient.dob }}{% endif %}
                                {% if patient.medicare %} - Medicare: {{ patient.medicare }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">This patient will be the active patient for this scenario and cannot be assigned to individual students.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Set Active Patient</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelPatientSelection()">Cancel</button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.question-text {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #007bff;
    white-space: pre-wrap;
}

.scenario-description {
    font-size: 1.1em;
    color: #6c757d;
    margin-bottom: 1rem;
}
</style>

<script>
function toggleQuestionEdit() {
    const displayDiv = document.getElementById('question-display');
    const editDiv = document.getElementById('question-edit');
    
    if (displayDiv.style.display === 'none') {
        displayDiv.style.display = 'block';
        editDiv.style.display = 'none';
    } else {
        displayDiv.style.display = 'none';
        editDiv.style.display = 'block';
    }
}

function cancelQuestionEdit() {
    const displayDiv = document.getElementById('question-display');
    const editDiv = document.getElementById('question-edit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function toggleDescriptionEdit() {
    const displayDiv = document.getElementById('description-display');
    const editDiv = document.getElementById('description-edit');
    
    if (displayDiv.style.display === 'none') {
        displayDiv.style.display = 'block';
        editDiv.style.display = 'none';
    } else {
        displayDiv.style.display = 'none';
        editDiv.style.display = 'block';
    }
}

function cancelDescriptionEdit() {
    const displayDiv = document.getElementById('description-display');
    const editDiv = document.getElementById('description-edit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function togglePatientSelection() {
    const displayDiv = document.getElementById('patient-display');
    const selectionDiv = document.getElementById('patient-selection');
    
    if (displayDiv.style.display === 'none') {
        displayDiv.style.display = 'block';
        selectionDiv.style.display = 'none';
    } else {
        displayDiv.style.display = 'none';
        selectionDiv.style.display = 'block';
    }
}

function cancelPatientSelection() {
    const displayDiv = document.getElementById('patient-display');
    const selectionDiv = document.getElementById('patient-selection');
    
    displayDiv.style.display = 'block';
    selectionDiv.style.display = 'none';
}
</script>
{% endblock %}
