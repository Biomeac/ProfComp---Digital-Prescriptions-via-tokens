{% extends "base.html" %}
{% block title %}[Student No] Pharmacy{% endblock %}

{% block head %}
    {% import "views/pt_detail_input.html" as pt %}
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/asl.css') }}">
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.3/html2pdf.bundle.min.js" integrity="sha512-yu5WG6ewBNKx8svICzUA01vozhmiQCVfzjzW40eCHJdsDRaOifh9hPlWBDex5b32gWCzawTp1F3FJz60ps6TnQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ url_for('static', filename='js/print_script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/asl.js') }}"></script>

    <script>
        const pt_id = {{ pt }};
        const pt_data = {{ pt_data|tojson }};
        const flatted_pt_data = flatten_dict(pt_data);
    </script>
{% endblock %}

{% block body %}
<div class="container">
    <h2>Active Script List</h2>
    <div class="row">
        <div id="customer-details" class="col">
            <div class="row">
                <h3>Customer Details (ASL)</h3>
            </div>
            <div class="row">
                <div class="col">
                    <h4>Name</h4>
                    <p>{{ pt_data['name'] }}</p>
                </div>
                <div class="col">
                    <h4>Date of Birth</h4>
                    <p>{{ pt_data['dob'] }}</p>
                </div>
                <div class="col">
                    <h4>Address</h4>
                    <p>{{ pt_data['address-1'] }} {{ pt_data['address-2'] }}</p>
                </div>
            </div>
            <div class="row">
                <h4>Preferred Contact</h4>
                <p>{{ pt_data['preferred-contact'] }}</p>
            </div>
        </div>
        
        <div id="customer-asl-info" class="col">
            <div class="card card-body customer-card">
                <div class="row">
                    <h3>ASL Information</h3>
                </div>
                <div class="row">
                    <div class="col">
                        <h4>Status</h4>
                        <p id="asl-status">Registered</p>
                    </div>
                    <div class="col">
                        <div class="d-flex flex-row justify-content-end gap-2">
                            <!-- onsent-status nested format -->
                            {% if pt_data['consent-status']['status'] == 'No Consent' %}
                                <button type="button" id="btn-request-access" class="btn btn-info">Request Access</button>
                                <button type="button" id="btn-refresh" class="btn btn-dark">Refresh</button>
                            {% elif pt_data['consent-status']['status'] == 'Granted' %}
                                <button type="button" id="btn-refresh" class="btn btn-dark">Refresh</button>
                            {% else %}
                                <button type="button" id="btn-request-access" class="btn btn-secondary" disabled>Request Access</button>
                                <button type="button" id="btn-refresh" class="btn btn-dark">Refresh</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <h4 class="col-12">Consent Status</h4>
                    <p class="d-flex justify-content-between align-items-center">
                        <span>
                            <!-- consent_status nested structure -->
                            {% if pt_data['consent-status']['status'] == 'No Consent' %}
                                <a id="consent-status" class="consent-no-consent">{{ pt_data['consent-status']['status'] }}</a>
                            {% elif pt_data['consent-status']['status'] == 'Pending' %}
                                <a id="consent-status" class="consent-pending">{{ pt_data['consent-status']['status'] }}</a>
                            {% elif pt_data['consent-status']['status'] == 'Granted' %}
                                <a id="consent-status" class="consent-granted">{{ pt_data['consent-status']['status'] }}</a>
                            {% elif pt_data['consent-status']['status'] == 'Rejected' %}
                                <a id="consent-status" class="consent-rejected">{{ pt_data['consent-status']['status'] }}</a>
                            {% endif %}
                            
                           
                            {% if pt_data['consent-status']['status'] != 'No Consent' %}
                            <a id="consent-last-updated"> (Last Updated {{ pt_data['consent-status']['last-updated'] }})</a>
                            {% endif %}
                        </span>
                      
                        {% if pt_data['consent-status']['status'] != 'No Consent' %}
                        <button type="button" id="btn-delete-consent" class="btn btn-secondary btn-sm">Delete Consent</button>
                        {% endif %}
                     </p>
                </div>
            </div>
        </div>
    </div>
    <br>
    
    {% if pt_data.get('can_view_asl') %}
    <div class="input-group">
        <span class="input-group-text" id="basic-addon1"><i class="bi bi-search"></i></span>
        <input type="search" id="search-input" class="form-control" placeholder="Search prescriptions" aria-label="Search" aria-describedby="basic-addon1">
    </div>
    <br>
    
    <div class="container">
        <div class="row">
            <div class="col-1">
                <button type="button" class="btn btn-light btn-collapse" data-bs-toggle="collapse" data-bs-target="#asl-table" aria-controls="asl-table">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
            <div class="col-10">
                <!-- CHANGED: Use asl-data instead of asl_data -->
                <p>ASL Scripts ({{ pt_data['asl-data']|length }} available)</p>
            </div>
            <div class="col-1">
                <!-- CHANGED: Use asl-data instead of asl_data -->
                {% if pt_data['asl-data']|length > 0 %}
                <button id="script-print" class="btn btn-outline-secondary btn-sm" title="Print Selected">
                    <i class="bi bi-printer-fill"></i>
                </button>
                {% endif %}
            </div>
        </div>
        
        <table id="asl-table" class="table collapse show">
            <thead>
                <tr>
                    <th scope="col">Select</th>
                    <th scope="col">Prescribed</th>
                    <th scope="col">Item</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Prescriber</th>
                    <th scope="col">Rpt</th>
                    <th scope="col">Paperless</th>
                </tr>
            </thead>
            <tbody>
                <!-- Use asl-data -->
                {% for asl in pt_data['asl-data'] %}
                <tr id="asl-{{ loop.index0 }}" class="asl-{{ 'paperless' if asl['paperless'] else 'paper' }} {% if asl['status'] == 'Dispensed' %}table-secondary{% endif %}">
                    <td class="asl-check">
                        {% if asl['status'] != 'Dispensed' %}
                        <input class="form-check-input" type="checkbox" value="{{ asl['prescription_id'] }}" id="asl-scripts-check-{{ loop.index }}">
                        {% else %}
                        <span class="badge bg-success">Dispensed</span>
                        {% endif %}
                    </td>
                    <td class="asl-date">{{ asl['prescribed-date'] }}</td>
                    <td class="asl-item">
                        {{ asl['drug-name'] }}
                        <p>{{ asl['DSPID'] }}</p>
                        {% if asl['status'] == 'Dispensed' %}
                        <small class="text-muted">Status: Dispensed</small>
                        {% endif %}
                    </td>
                    <td class="asl-qty">{{ asl['dose-qty'] }}</td>
                    <td class="asl-prescriber">{{ asl['prescriber']['lname'] }}, {{ asl['prescriber']['fname'] }}<br>{{ asl['prescriber']['id'] }}</td>
                    <td class="asl-rpt">{{ asl['dose-rpt'] }}</td>
                    <td class="asl-cloud-prescription"><img src="{{ url_for('static', filename='cloud-prescription.svg') }}"/></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Dispense button - shows when prescriptions are selected -->
    <div class="container mt-3">
        <div class="row">
            <div class="col-12 text-end">
                <button id="dispense-selected" class="btn btn-success" style="display: none;">
                    <i class="bi bi-capsule"></i> Dispense Selected
                </button>
            </div>
        </div>
    </div>
    
    <br>
    
    <div class="container">
        <div class="row">
            <div class="col-1">
                <button type="button" class="btn btn-light btn-collapse" data-bs-toggle="collapse" data-bs-target="#alr-table" aria-controls="alr-table">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
            <div class="col-11">
                <!-- Use alr-data  -->
                <p>Available Local Repeats - View Only ({{ pt_data['alr-data']|length }} with remaining repeats)</p>
            </div>
        </div>
        
        <table id="alr-table" class="table collapse show">
            <thead>
                <tr>
                <th scope="col">Dispensed</th>
                <th scope="col">Item</th>
                <th scope="col">Qty</th>
                <th scope="col">Prescribed</th>
                <th scope="col">Rpt</th>
                <th scope="col">Remaining</th>
                <th scope="col">Paperless</th>
                </tr>
            </thead>
            <tbody>
               
                {% for alr in pt_data['alr-data'] %}
                <tr id="alr-{{ loop.index }}" class="alr-{{ 'paperless' if alr['paperless'] else 'paper' }}">
                    <td class="alr-date">{{ alr['dispensed-date'] }}</td>
                    <td class="alr-item">{{ alr['drug-name'] }}<p>{{ alr['dose-instr'] }}</p></td>
                    <td class="alr-qty">{{ alr['dose-qty'] }}</td>
                    <td class="alr-prescriber">{{ alr['prescriber']['lname'] }}, {{ alr['prescriber']['fname'][0] }}<br>{{ alr['prescribed-date'] }}</td>
                    <td class="alr-rpt">{{ alr['dose-rpt'] }}</td>
                    <td class="alr-remaining">{{ alr.get('remaining-repeats', 'N/A') }}</td>
                    <td class="alr-cloud-prescription"><img src="{{ url_for('static', filename='cloud-prescription.svg') }}"/></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% else %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        Access to ASL is restricted. Please check consent status.
    </div>
    {% endif %}
</div>

<!-- Dispensing Modal -->
<div class="modal fade" id="dispensingModal" tabindex="-1" aria-labelledby="dispensingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dispensingModalLabel">
                    <i class="bi bi-capsule"></i> Dispense Prescriptions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="selected-prescriptions">
                    <!-- Selected prescriptions will be populated here -->
                </div>
                <form id="dispensing-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="patient_id" value="{{ pt }}">
                    <input type="hidden" id="prescription-ids" name="prescription_ids" value="">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="dispensed_by" class="form-label">Dispensed By</label>
                            <input type="text" class="form-control" id="dispensed_by" name="dispensed_by" 
                                   value="{{ current_user.get_full_name() if current_user else '' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dispensed_date" class="form-label">Dispensed Date</label>
                            <input type="text" class="form-control" id="dispensed_date" name="dispensed_date" 
                                   value="" required>
                        </div>
                        <div class="col-12">
                            <label for="dispensing_notes" class="form-label">Dispensing Notes</label>
                            <textarea class="form-control" id="dispensing_notes" name="dispensing_notes" 
                                      rows="3" placeholder="Add any notes about the dispensing..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-dispense">
                    <i class="bi bi-check-circle"></i> Confirm Dispensing
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle prescription selection for dispensing
    const checkboxes = document.querySelectorAll('#asl-table input[type="checkbox"]');
    const dispenseButton = document.getElementById('dispense-selected');
    
    // Show/hide dispense button based on selection
    function toggleDispenseButton() {
        const checkedBoxes = document.querySelectorAll('#asl-table input[type="checkbox"]:checked');
        dispenseButton.style.display = checkedBoxes.length > 0 ? 'inline-block' : 'none';
    }
    
    // Add event listeners to checkboxes
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', toggleDispenseButton);
    });
    
    // Handle dispense button click
    dispenseButton.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('#asl-table input[type="checkbox"]:checked');
        const selectedPrescriptions = Array.from(checkedBoxes).map(cb => {
            const row = cb.closest('tr');
            const cells = row.querySelectorAll('td');
            return {
                id: cb.value,
                prescribed_date: cells[1].textContent.trim(),
                drug_name: cells[2].querySelector('p') ? cells[2].textContent.split('\n')[0].trim() : cells[2].textContent.trim(),
                dspid: cells[2].querySelector('p') ? cells[2].querySelector('p').textContent.trim() : '',
                quantity: cells[3].textContent.trim(),
                prescriber: cells[4].textContent.split('\n')[0].trim(),
                repeats: cells[5].textContent.trim()
            };
        });
        
        // Populate modal with selected prescriptions
        populateDispensingModal(selectedPrescriptions);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('dispensingModal'));
        modal.show();
    });
    
    function populateDispensingModal(prescriptions) {
        const container = document.getElementById('selected-prescriptions');
        const prescriptionIds = document.getElementById('prescription-ids');
        
        // Set prescription IDs
        prescriptionIds.value = prescriptions.map(p => p.id).join(',');
        
        // Create prescription cards
        container.innerHTML = prescriptions.map(prescription => `
            <div class="card mb-2">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="card-title mb-1">${prescription.drug_name}</h6>
                            <small class="text-muted">DSPID: ${prescription.dspid}</small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Quantity:</small><br>
                            <strong>${prescription.quantity}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Repeats:</small><br>
                            <strong>${prescription.repeats}</strong>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Prescriber: ${prescription.prescriber}</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Prescribed: ${prescription.prescribed_date}</small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Handle confirm dispensing
    document.getElementById('confirm-dispense').addEventListener('click', function() {
        const form = document.getElementById('dispensing-form');
        const formData = new FormData(form);
        
        // Submit dispensing request
        fetch(`/api/dispense/${pt_id}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrf_token')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('dispensingModal')).hide();
                
                // Show success message
                showAlert('success', 'Prescriptions dispensed successfully!');
                
                // Refresh page to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showAlert('error', data.message || 'Error dispensing prescriptions');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while dispensing prescriptions');
        });
    });
    
    // Set current date in dispensed_date field
    const today = new Date();
    const formattedDate = today.toLocaleDateString('en-GB'); // DD/MM/YYYY format
    document.getElementById('dispensed_date').value = formattedDate;
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at top of container
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script>
</div>
{% endblock %}